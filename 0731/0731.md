## 0. Overview
- Species Distribution Modeling (SDM)
    - Model?
    - Model fitting?
    - Model prediction?
    - Model evaluation?
- Bioclim
- Maxent
    - Maxent 알고리즘?
    - Maxent 구동 환경 구축하기
    - Maxent 돌려보기

## 1. Species Distribution Modeling (SDM)

### 1.1 Model?
- Model 이란, 어떠한 numerical tool을 말한다. 
- 그 tool은 어떠한 변수들에 대한 관찰(input) 데이터를 가지고, 그 변수들의 예측값(output)을 만들어낼 수 있는 것들을 말한다.
- 우리가 다루는 Species distribution model들은 환경 변수들에 대한 species occurrence 관찰 데이터를 가지고, 그 환경 변수들의 예측값을 만들어낼 수 있는 모델들이다. 이번 시간에는 많은 모델들 중 `Bioclim`과 `MaxEnt`를 실행해 본다.

### 1.2 Model fitting?
- Model fitting이란 관찰 데이터에 가장 잘 맞는(fit) 모델을 만드는 과정을 말한다.
- 각 모델마다 fitting하는 방식은 다양하나, 큰 컨셉을 얘기해보자면 모델을 구성하고 있는 파라미터를 가장 좋은 것으로 튜닝하는 작업으로 말할 수 있을 것 같다.

### 1.3 Model prediction?
- Fitting된 모델로 원하는 변수의 예측값을 얻어내는 것이다.

### 1.4 Model evaluation?
- Model이 예측을 잘 하는지 평가하는 것을 말한다.
- 원하는 task마다 model을 평가하기 위한 index가 보통 존재한다. 이 index값이 model 평가 점수 결과라고 보면 된다.
    - 낮을 수록 좋은 model을 의미하는 index도 있고, 높을 수록 좋은 model을 의미하는 index도 있다.
- cf) Training / Test set

## 2. Bioclim
## 2.1 Bioclim 모델 만들기
- `dismo` 패키지의 `bioclim()` 사용
- `bioclim()`
    - 주어진 환경변수와 관찰 데이터를 받아서
    - 잘(?) fitting된 bioclim 모델을 만든다
    ```R
    bioclim(x,   # Raster data
            p,   # 2개 열로 이루어진 occurrence 위치 데이터
            ...
    )
    ```
- 예) 한국에 있는 이팝나무의 데이터로 fitting시킨 bioclim 모델을 만들어 보자.
    - 1) Data 준비. 0724.md의 2.2예제랑 비슷.
        ```R
        # Get Worldclim bio data
        library(raster)
        worldclim <- getData('worldclim', download=TRUE, var='bio', res=2.5)

        # Read occurrence data of Chionanthus retusus in Korea
        library(readxl)
        dirpath <- '/Users/haekyu/Downloads/Jiyeon/0724/data/'
        filepath <- paste(dirpath, 'treedb.xlsx', sep='')
        df <- read_excel(filepath, 2)
        retusus_df <- df[df$kind == 'Chionanthus retusus',]

        # Get bio climate variable of Chionanthus retusus
        retusus_lon_lat <- cbind(retusus_df[,'lon'], retusus_df[,'lat'])
        retusus_bio <- extract(worldclim, retusus_lon_lat)
        retusus_bio <- na.omit(retusus_bio)
        retusus_bio <- as.data.frame(retusus_bio)

        # Print results
        print('------- retusus_df -------------------------')
        print(head(retusus_df))
        print('')
        print('------- retusus_bio (1:3 column only) ------')
        print(head(retusus_bio[,1:3]))
        ```
        출력 결과
        ```
        [1] "------- retusus_df -------------------------"
        # A tibble: 6 x 3
          kind                  lat   lon
          <chr>               <dbl> <dbl>
        1 Chionanthus retusus  35.0  129.
        2 Chionanthus retusus  35.8  129.
        3 Chionanthus retusus  37.3  127.
        4 Chionanthus retusus  37.3  127.
        5 Chionanthus retusus  36.3  129.
        6 Chionanthus retusus  34.4  127.

        [1] "------- retusus_bio (1:3 column only) ------"
          bio1 bio2 bio3
        1  141   91   28
        2  119  105   29
        3  114   96   25
        4  116   96   25
        5  109  106   29
        6  137   77   25
        ```
    - 2) 위에서 구한 이팝나무 bio 데이터로 fitting시킨 bioclim 모델 만들기. 
        - bio 변수는 1,2,3 만 사용한다고 가정
        ```R
        bc_model <- bioclim(retusus_bio[,c('bio1', 'bio2', 'bio3')])
        ```

## 2.2 Bioclim 모델로 변수값 예측하기
- `dismo` 패키지의 `predict()` 함수 사용
- `predict()` 함수
    - fitting된 모델과 
    - bio 변수 데이터를 넣어주면
    - bioclim 모델의 예측값이 나온다. (예측값...?)
    ```R
    predict(object,     # fitting된 모델. 
            x,          # 변수 데이터. data.frame 등을 넣어줄 수 있음.
            ...
    )
    ```
    - 예)


        





# Build a fitted bioclim model with the Chionanthus retusus bio data
bc_model <- bioclim(retusus_bio[,c('bio1', 'bio2', 'bio3')])

# Make a test set
bio1 <- c(138, 137, 142)
bio2 <- c(87, 77, 83)
bio3 <- c(27, 25, 27)
test = data.frame(cbind(bio1, bio2, bio3))
prediction <- predict(bc_model, test)
response(bc_model)




object  A fitted model of class Bioclim, Domain, MaxEnt, ConvexHull, or Mahalanobis (classes that inherit from DistModel)
x   A Raster* object or a data.frame
ext An extent object to limit the prediction to a sub-region of 'x'. Or an object that can be coerced to an Extent object by extent; such as a Raster* or Spatial* object
filename    Output filename for a new raster; if NA the result is not written to a file but returned with the RasterLayer object, in the data slot
progress    Character. Valid values are "" (no progress bar), "text" and "windows" (on that platform only)
... Additional model specific arguments. And additional arguments for file writing as for writeRaster

## 3. Maxent 알고리즘
- Species distribution modeling with R.pdf의 chapter 11.1
- Machine learning methods

## Maxent 구동 환경 구축하기
- Maxent 프로그램 다운로드 받기
    - [Maxent Link](http://biodiversityinformatics.amnh.org/open_source/maxent/)에서 maxent 프로그램 다운로드
    - `maxent.jar` 파일이 있는지 확인
- `maxent.jar` 파일을 dismo 패키지 내 java폴더 안에 넣기
    - `system.file("java", package="dismo")` 을 실행시키면 dismo 패키지 내 java 폴더가 위치한경로를 알아낼 수 있다.
        - 예)
        ```R
        > system.file("java", package="dismo")
        [1] "/Library/Frameworks/R.framework/Versions/3.5/Resources/library/dismo/java"
        ```
    - 위 java 폴더 안에 `maxent.jar` 파일을 넣는다.
        - 예) Shell 에서 이동시켜도 됨. (물론 아래처럼 하지 않고 폴더 찾아서 마우스로 드래그 앤 드롭 / 파일 복사 해도 됩니다.)
        ```R
        # dismo 패키지의 java 폴더로 이동
        # cf) 위에서 나온 경로를 그대로 복사 붙여넣기 했습니다.
        cd "/Library/Frameworks/R.framework/Versions/3.5/Resources/library/dismo/java"

        # 다운받은 maxent.jar 파일을 현재 위치(java 폴더)에 복사.
        # cf) 제 컴퓨터에서는 maxent.jar이 ~/Downloads/maxent/maxent.jar 에 위치해있습니다. 
        # cf) maxent.jar의 경로는 다를 수 있습니다.
        cp ~/Downloads/maxent/maxent.jar .
        ```